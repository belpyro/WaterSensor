<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>ESP Config</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root{
      --bg:#fafafa; --fg:#111; --muted:#666; --card:#fff; --br:#e6e6e6; --accent:#1f7ae0;
      --danger:#d93025;
    }
    *{box-sizing:border-box}
    body{font-family:system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, "Helvetica Neue", Arial;
         margin:0; background:var(--bg); color:var(--fg);}
    .wrap{max-width:760px; margin:auto; padding:24px 16px;}
    h1{font-size:1.4rem; margin:0 0 12px}
    h2{font-size:1.1rem; margin:0 0 8px}
    p{margin:.3rem 0}
    .card{background:var(--card); border:1px solid var(--br); border-radius:14px; padding:16px; margin:14px 0;
          box-shadow:0 1px 2px rgba(0,0,0,.04);}
    label{display:block; margin:.6rem 0 .25rem; font-weight:600}
    input[type="text"], input[type="number"]{width:100%; padding:.6rem .65rem; border:1px solid var(--br);
         border-radius:10px; outline:none}
    input[type="checkbox"]{transform:scale(1.15); margin-right:.4rem}
    .row{display:grid; grid-template-columns:1fr 1fr; gap:12px}
    .row > div{min-width:0}
    @media (max-width:640px){ .row{grid-template-columns:1fr} }

    .btn{appearance:none; border:1px solid var(--br); background:#fff; padding:.55rem .9rem; border-radius:10px;
         cursor:pointer; transition:.15s; font-weight:600}
    .btn:hover{border-color:#cfcfcf}
    .btn.primary{background:var(--accent); color:#fff; border-color:var(--accent)}
    .btn.secondary{background:#fff}
    .btn.danger{background:#fff; color:var(--danger); border-color:#f1c9c6}
    .muted{color:var(--muted); font-size:.92rem}
    code{background:#f3f3f3; padding:.15rem .35rem; border-radius:6px}
    #fwstatus{margin-left:.5rem; font-weight:600}
    .kv{font-family: ui-monospace, Menlo, Consolas, "SF Mono", monospace; font-size:.95rem; white-space:pre-wrap}
    .actions{display:flex; gap:.5rem; flex-wrap:wrap; margin-top:.5rem}

    /* badges for calibration status */
    .badge{display:inline-block; padding:.2rem .6rem; border-radius:999px; border:1px solid var(--br); background:#fff; font-weight:600}
    .badge.live{background:#eaf2fe; border-color:#d7e6fd; color:var(--accent)}
    .badge.warn{background:#fff6db; border-color:#ffe8a3; color:#8a6d3b}
  </style>
</head>
<body>
<div class="wrap">
  <h1>ESP8266 Config</h1>

  <!-- Config -->
  <section class="card">
    <h2>Device Settings</h2>
    <form id="f">
      <div class="row">
        <div>
          <label for="deviceName">Device Name</label>
          <input id="deviceName" type="text" required>
        </div>
        <div>
          <label for="mqttServer">MQTT Server</label>
          <input id="mqttServer" type="text" required>
        </div>
      </div>
      <div class="row">
        <div>
          <label for="mqttPort">MQTT Port</label>
          <input id="mqttPort" type="number" value="1883" min="1" max="65535">
        </div>
        <div style="display:flex; align-items:center; margin-top:1.7rem">
          <label style="display:flex; align-items:center; gap:.5rem; margin:0">
            <input id="alarmEnabled" type="checkbox"> Alarm Enabled
          </label>
        </div>
      </div>
      <div class="actions">
        <button class="btn primary" type="submit">Save</button>
      </div>
    </form>
  </section>

  <!-- OTA -->
  <section class="card">
    <h2>Firmware Update (OTA)</h2>
    <p class="muted">Upload compiled firmware <code>.bin</code> to flash over Wi-Fi.</p>
    <form id="fwform" method="POST" action="/update" enctype="multipart/form-data">
      <input type="file" name="update" id="fwfile" accept=".bin" required>
      <button class="btn" type="submit">Upload</button>
      <span id="fwstatus"></span>
    </form>
  </section>

  <!-- Capacitive calibration -->
  <section class="card">
    <h2>Capacitive Sensor (Calibration)</h2>
    <!-- NEW: status badge -->
    <div class="muted" style="margin:.25rem 0 .5rem">
      Status: <span id="capState" class="badge">Not calibrated</span>
    </div>

    <p class="muted">Use when the sensor area is <strong>dry</strong>. Values refresh every 5 seconds.</p>
    <div id="capstats" class="kv">Loading…</div>
    <div class="actions">
      <button class="btn" id="capStart">Start 5s Calibrate</button>
      <button class="btn secondary" id="capBlocking">Blocking 5s</button>
      <button class="btn secondary" id="capSave">Save</button>
      <button class="btn danger" id="capReset">Reset</button>
    </div>
  </section>

  <p class="muted">Tip: after OTA, the device may reboot and the page can disconnect briefly.</p>
</div>

<script>
  // ---------- Firmware upload ----------
  const fwform = document.getElementById('fwform');
  const fwfile = document.getElementById('fwfile');
  const fwstatus = document.getElementById('fwstatus');
  fwform.addEventListener('submit', async (e) => {
    e.preventDefault();
    if (!fwfile.files.length) return;
    const fd = new FormData();
    fd.append('update', fwfile.files[0]);
    fwstatus.textContent = 'Uploading…';
    try {
      const res = await fetch('/update', { method: 'POST', body: fd });
      const txt = await res.text();
      fwstatus.textContent = res.ok ? ('OK: ' + txt) : ('Error: ' + txt);
    } catch (err) {
      fwstatus.textContent = 'Network error: ' + err;
    }
  });

  // ---------- Device config ----------
  async function refreshConfig(){
    try{
      const r = await fetch('/config'); const j = await r.json();
      deviceName.value = j.deviceName || '';
      mqttServer.value = j.mqttServer || '';
      mqttPort.value   = j.mqttPort ?? 1883;
      alarmEnabled.checked = !!j.alarmEnabled;
    }catch(e){ console.warn(e); }
  }
  async function save(e){
    e.preventDefault();
    const body = {
      deviceName: deviceName.value.trim(),
      mqttServer: mqttServer.value.trim(),
      mqttPort: +mqttPort.value,
      alarmEnabled: alarmEnabled.checked
    };
    const res = await fetch('/config', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(body) });
    alert(res.ok ? 'Saved!' : 'Error saving');
  }
  document.getElementById('f').addEventListener('submit', save);
  refreshConfig();

  // ---------- Capacitive calibration UI ----------
  (function(){
    const statsEl = document.getElementById('capstats');
    const stateEl = document.getElementById('capState');
    const btnStart = document.getElementById('capStart');
    const btnBlock = document.getElementById('capBlocking');
    const btnSave  = document.getElementById('capSave');
    const btnReset = document.getElementById('capReset');

    const fmt = (s)=>`t_us: ${s.t_us}
dry_ema: ${s.dry_ema}
th_on: ${s.th_on}
th_off: ${s.th_off}
wet: ${s.wet}
calibrated: ${s.calibrated}
hitsWet: ${s.hitsWet}  hitsDry: ${s.hitsDry}
calibrating: ${s.calibrating}`;

    async function refresh(){
      try{
        const r = await fetch('/cap/status');
        const j = await r.json();

        // badge: Calibrating / Not calibrated / Ready
        const cal = !!j.calibrating;
        const inited = !!j.calibrated;
        if (cal) {
          stateEl.textContent = 'Calibrating…';
          stateEl.className = 'badge live';
        } else if (!inited) {
          stateEl.textContent = 'Not calibrated';
          stateEl.className = 'badge warn';
        } else {
          stateEl.textContent = 'Ready';
          stateEl.className = 'badge';
        }

        // Lock start buttons only while calibrating
        btnStart.disabled = cal;
        btnBlock.disabled = cal;
        // Save/Reset always available
        btnSave.disabled = false;
        btnReset.disabled = false;

        statsEl.textContent = fmt(j);
      }catch(e){
        statsEl.textContent = 'Error: ' + e;
      }
    }
    // refresh every second (as per text)
    setInterval(refresh, 5000);
    refresh();

    document.getElementById('capStart').onclick = async ()=>{
      const r = await fetch('/cap/calibrate/start?ms=5000&step=20', {method:'POST'});
      alert(await r.text());
    };
    document.getElementById('capBlocking').onclick = async ()=>{
      const r = await fetch('/cap/calibrate/blocking?ms=5000&step=20', {method:'POST'});
      alert(await r.text());
      refresh();
    };
    document.getElementById('capSave').onclick = async ()=>{
      const r = await fetch('/cap/save', {method:'POST'});
      alert(await r.text());
    };
    document.getElementById('capReset').onclick = async ()=>{
      if(!confirm('Delete /capcal.json and reset baseline?')) return;
      const r = await fetch('/cap/calibrate/reset', {method:'POST'});
      alert(await r.text());
      refresh();
    };
  })();
</script>
</body>
</html>